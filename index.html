<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reportes AENOR - Inspección Estructural</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #667eea; --secondary: #764ba2; --success: #27ae60; --white: #ffffff; }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 20px;
        }
        .container {
            background: var(--white); width: 100%; max-width: 950px;
            padding: 30px; border-radius: 15px; box-shadow: 0 15px 35px rgba(0,0,0,0.2);
        }
        .slide { display: none; animation: fadeIn 0.4s ease; }
        .slide.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        h2, h3 { color: #333; margin-bottom: 20px; text-align: center; border-bottom: 2px solid #eee; padding-bottom: 10px; }
        h4 { color: var(--secondary); margin: 15px 0 10px 0; font-size: 1rem; border-left: 4px solid var(--secondary); padding-left: 10px; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; color: #555; font-size: 0.85rem; }
        input, select { width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 8px; font-size: 0.9rem; }
        .inspector-block { background: #f9f9f9; padding: 15px; border-radius: 10px; margin-bottom: 20px; border: 1px solid #eee; }
        table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.8rem; }
        th, td { border: 1px solid #eee; padding: 8px; text-align: left; }
        th { background: #f8f9fa; color: #333; }
        .buttons { display: flex; justify-content: space-between; margin-top: 30px; }
        button { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-prev { background: #e0e0e0; color: #333; }
        .btn-next { background: var(--primary); color: white; }
        .btn-export { background: var(--success); color: white; display: none; width: 100%; margin-top: 20px; font-size: 1.1rem; }
        button:hover { opacity: 0.9; transform: scale(1.01); }
        button:disabled { background: #ccc; cursor: not-allowed; }
    </style>
</head>
<body>

<div class="container">
    <form id="formReporte">
        <h2>REPORTE TÉCNICO AENOR</h2>

        <div class="slide active">
            <h3><i class="fas fa-handshake"></i> Datos del Cooperador</h3>
            <div class="form-grid">
                <div><label>Razón Social (E11)</label><input type="text" name="razon_social"></div>
                <div><label>RUC (T11)</label><input type="text" name="ruc"></div>
            </div>
            <h4>Personal en Campo</h4>
            <div class="form-grid">
                <div><label>P1 Nombre (D12)</label><input type="text" name="p1_nombre"></div>
                <div><label>P1 Cargo (H12)</label><input type="text" name="p1_cargo"></div>
                <div><label>P1 Empresa (Q12)</label><input type="text" name="p1_empresa"></div>
                <div><label>P1 DNI (T12)</label><input type="text" name="p1_dni"></div>
            </div>
            <div class="form-grid">
                <div><label>P2 Nombre (D13)</label><input type="text" name="p2_nombre"></div>
                <div><label>P2 Cargo (H13)</label><input type="text" name="p2_cargo"></div>
                <div><label>P2 Empresa (Q13)</label><input type="text" name="p2_empresa"></div>
                <div><label>P2 DNI (T13)</label><input type="text" name="p2_dni"></div>
            </div>
        </div>

        <div class="slide">
            <h3><i class="fas fa-broadcast-tower"></i> Datos del Proyecto</h3>
            <div class="form-grid">
                <div><label>Nombre Site (E20)</label><input type="text" name="nombre_site"></div>
                <div><label>Proyecto (L20)</label><input type="text" name="proyecto"></div>
                <div><label>Solución (T20)</label><input type="text" name="solucion"></div>
            </div>
            <div class="form-grid">
                <div><label>Ubicación Geog. (E24)</label><input type="text" name="distrito" placeholder="Dep/Prov/Dist"></div>
                <div><label>N. MOP (T21)</label><input type="text" name="n_mop"></div>
                <div><label>Dirección (E22)</label><input type="text" name="direccion"></div>
            </div>
        </div>

        <div class="slide">
            <h3><i class="fas fa-user-check"></i> Datos del Inspector</h3>
            <div class="inspector-block">
                <h4>Inspector 01</h4>
                <div class="form-grid">
                    <div><label>Nombre (D28)</label><input type="text" name="inspector_nombre"></div>
                    <div><label>Cargo (H28)</label><input type="text" name="ins1_cargo"></div>
                    <div><label>Empresa (O28)</label><input type="text" name="ins1_empresa"></div>
                    <div><label>DNI/CE (T28)</label><input type="text" name="ins1_dni"></div>
                </div>
            </div>
            <div class="inspector-block">
                <h4>Inspector 02</h4>
                <div class="form-grid">
                    <div><label>Nombre (D29)</label><input type="text" name="ins2_nombre"></div>
                    <div><label>Cargo (H29)</label><input type="text" name="ins2_cargo"></div>
                    <div><label>Empresa (O29)</label><input type="text" name="ins2_empresa"></div>
                    <div><label>DNI/CE (T29)</label><input type="text" name="ins2_dni"></div>
                </div>
            </div>
            <div class="form-grid">
                <div><label>Fecha Inicio (F30)</label><input type="date" name="fecha_inicio"></div>
                <div><label>Fecha Fin (R30)</label><input type="date" name="fecha_fin"></div>
            </div>
        </div>

        <div class="slide">
            <h3><i class="fas fa-list-ol"></i> Verificación Estructural</h3>
            <div style="overflow-x:auto;">
                <table>
                    <thead><tr><th>Ítem</th><th>Estado</th><th>Paraliza</th><th>Obs</th></tr></thead>
                    <tbody id="checklist-container"></tbody>
                </table>
            </div>
            <button type="button" class="btn-export" id="btnExportar" onclick="generarExcel()">
                <i class="fas fa-file-excel"></i> GENERAR REPORTE EN EXCEL
            </button>
        </div>

        <div class="buttons">
            <button type="button" class="btn-prev" onclick="changeSlide(-1)">Anterior</button>
            <button type="button" class="btn-next" id="btnNext" onclick="changeSlide(1)">Próximo</button>
        </div>
    </form>
</div>

<script>
    let currentSlide = 0;
    const slides = document.querySelectorAll(".slide");
    const btnNext = document.getElementById("btnNext");
    const btnExport = document.getElementById("btnExportar");

    const preguntas = [
        "Presenta fisuras en el concreto", "Presenta desprendimientos", "Presenta humedad",
        "Presenta grouting", "Presenta óxido (Anclajes)", "Presenta tuerca y contra tuerca",
        "Presenta deformación (Plancha)", "Presenta óxido (Plancha)", "Presenta fisuras en la plancha", "Presenta fisuras en la soldadura",
        "Pernos faltantes (>30%)", "Óxido en pernos", "Tuerca y contra tuerca (Conex)", "Óxido en planchas", "Fisuras en plancha", "Fisuras en soldadura",
        "Óxido en montantes", "Óxido en diagonales", "Óxido en redundantes", "Óxido en horizontales", "Óxido en escaleras de acceso", "Óxido en línea de vida",
        "Óxido en roldanas", "Óxido en soportes", "Corrosión en montantes", "Corrosión en diagonales", "Corrosión en redundantes", "Corrosión en horizontales",
        "Corrosión en escaleras de acceso", "Corrosión en línea de vida", "Corrosión en roldanas", "Corrosión en soportes", "Pérdida de pintura", "Pérdida de galvanizado",
        "Deformación vertical (>2%)", "Movimiento en tope de torre", "Tensión en vientos", "Fijación contravientos", "Línea de vida sin continuidad",
        "Empozamiento de agua", "Filtraciones", "Falta de limpieza", "Acumulación desperdicios", "Crecimiento vegetación", "Heces de aves"
    ];

    function initChecklist() {
        const container = document.getElementById("checklist-container");
        preguntas.forEach((p, i) => {
            container.innerHTML += `<tr>
                <td>${i+1}. ${p}</td>
                <td><select name="p${i+1}_status"><option value="N/A">N/A</option><option value="SI">SI</option><option value="NO">NO</option></select></td>
                <td><input type="checkbox" name="p${i+1}_paraliza" value="SI"></td>
                <td><input type="text" name="p${i+1}_obs" placeholder="..."></td>
            </tr>`;
        });
    }

    function changeSlide(n) {
        slides[currentSlide].classList.remove("active");
        currentSlide += n;
        if (currentSlide === slides.length - 1) { btnNext.style.display = "none"; btnExport.style.display = "block"; }
        else { btnNext.style.display = "block"; btnExport.style.display = "none"; }
        slides[currentSlide].classList.add("active");
    }

    async function generarExcel() {
        const btn = document.getElementById("btnExportar");
        btn.disabled = true;
        btn.innerHTML = "PROCESANDO...";
        const formData = new FormData(document.getElementById("formReporte"));
        
        try {
            const response = await fetch('https://backend-reportes-excel.onrender.com/generar-reporte', {
                method: 'POST',
                body: JSON.stringify(Object.fromEntries(formData.entries())),
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) throw new Error('Error en servidor');
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Reporte_${formData.get('nombre_site') || 'AENOR'}.xlsx`;
            a.click();
            alert("✅ Reporte guardado en Debian y Excel generado.");
        } catch (err) {
            alert("❌ Error: " + err.message);
        } finally {
            btn.disabled = false;
            btn.innerHTML = "GENERAR REPORTE EN EXCEL";
        }
    }
    initChecklist();
</script>
</body>
</html>
