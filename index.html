<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte T茅cnico AENOR</title>
    <style>
        /* ESTILOS ORIGINALES DEL GIST */
        body { font-family: Arial, sans-serif; background-color: #f4f4f9; margin: 0; padding: 20px; }
        .container { max-width: 900px; margin: auto; background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; }
        .slide { display: none; }
        .slide.active { display: block; }
        .section { margin-bottom: 20px; border: 1px solid #ccc; padding: 15px; border-radius: 5px; }
        .section h2 { margin-top: 0; font-size: 18px; color: #005c97; border-bottom: 2px solid #005c97; padding-bottom: 5px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .grid-quad { display: grid; grid-template-columns: 1fr 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        .grid-triple { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 10px; }
        label { font-weight: bold; display: block; margin-bottom: 5px; font-size: 11px; }
        input, select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
        
        /* DISEO PARTE IV: ORDEN ACTUALIZADO */
        .checklist-item { display: grid; grid-template-columns: 2fr 0.8fr 1fr 1.5fr; gap: 8px; align-items: center; margin-bottom: 10px; padding-bottom: 5px; border-bottom: 1px solid #eee; font-size: 12px; }
        
        .btn-nav { display: flex; justify-content: space-between; margin-top: 20px; }
        button { padding: 10px 20px; background-color: #005c97; color: white; border: none; border-radius: 5px; cursor: pointer; font-weight: bold; }
        
        /* ESTILOS PESTAAS */
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 20px; }
        .nav-tabs button { background: #ddd; color: #333; }
        .nav-tabs button.active { background: #005c97; color: white; }
        #tablaHistorial { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 12px; }
        #tablaHistorial th, #tablaHistorial td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #tablaHistorial th { background: #005c97; color: white; }
    </style>
</head>
<body>

    <div class="nav-tabs">
        <button onclick="cambiarSeccion('app')" id="tab-app" class="active"> NUEVO REPORTE</button>
        <button onclick="cambiarSeccion('hist')" id="tab-hist"> VER HISTORIAL</button>
    </div>

    <div class="container">
        
        <div id="seccion-app">
            <h1>Reporte T茅cnico AENOR</h1>

            <!-- PARTE I: COOPERADOR -->
<div class="slide active">
    <div class="section">
        <h2>I. DATOS DEL COOPERADOR</h2>
        <div class="grid">
            <div>
                <label>Raz贸n Social (E11):</label>
                <!-- list="listaCooperadores" activa las sugerencias -->
                <input type="text" id="E11" list="listaCooperadores" oninput="vincularRUC(this.value)" placeholder="Escriba o seleccione...">
                <datalist id="listaCooperadores"></datalist>
            </div>
            <div>
                <label>RUC (T11):</label>
                <input type="text" id="T11">
            </div>
        </div>
        <script>
            let baseDatosCooperadores = [];

            // FUNCIN PARA CARGAR SUGERENCIAS DESDE LA DB
            async function cargarCooperadores() {
                try {
                    const res = await fetch('https://backend-reportes-excel.onrender.com/cooperadores-frecuentes');
                    baseDatosCooperadores = await res.json();
                    const datalist = document.getElementById('listaCooperadores');
                    datalist.innerHTML = ''; // Limpiar
                    baseDatosCooperadores.forEach(c => {
                        let opcion = document.createElement('option');
                        opcion.value = c.razon_social;
                        datalist.appendChild(opcion);
                    });
                    console.log("Sugerencias cargadas:", baseDatosCooperadores.length);
                } catch (e) { console.error("Error al cargar sugerencias"); }
            }

            // Ejecutar carga al abrir la app
            cargarCooperadores();

            // Vincular RUC autom谩ticamente al elegir sugerencia
            function vincularRUC(valor) {
                const match = baseDatosCooperadores.find(c => c.razon_social === valor);
                if (match) document.getElementById('T11').value = match.ruc;
            }

            // Auto-relleno de Empresa (Solo si hay nombre escrito)
            function rellenarEmpresa(id) {
                const nombre = document.getElementById(`D${id}`).value;
                const cooperador = document.getElementById('E11').value;
                if (nombre.trim() !== "" && cooperador !== "") {
                    document.getElementById(`O${id}`).value = cooperador;
                }
            }

            const pers = [12, 13, 14, 15, 16];
            pers.forEach((id, i) => {
                document.write(`
                    <label>PERSONAL 0${i+1}</label>
                    <div class="grid-quad">
                        <input type="text" id="D${id}" placeholder="Nombre" onblur="rellenarEmpresa('${id}')">
                        <input type="text" id="H${id}" placeholder="Cargo">
                        <input type="text" id="O${id}" placeholder="Empresa">
                        <input type="text" id="T${id}" placeholder="DNI">
                    </div>
                `);
            });
        </script>
    </div>
    <div class="btn-nav"><button style="visibility:hidden">Anterior</button><button onclick="moveSlide(1)">Pr贸ximo</button></div>
</div>

           <!-- PARTE II: PROYECTO -->
<div class="slide">
    <div class="section">
        <h2>II. DATOS DEL PROYECTO Y SITE</h2>
        <div class="grid-triple">
            <div>
                <label>Nombre Site (E20):</label>
                <input type="text" id="E20" list="listaSitiosHistoricos" oninput="vincularDatosSite(this.value)">
                <datalist id="listaSitiosHistoricos"></datalist>
            </div>
            <div><label>Proyecto (L20):</label><input type="text" id="L20"></div>
            <div><label>Soluci贸n (T20):</label><input type="text" id="T20"></div>
        </div>
        <div class="grid-triple">
            <div><label>Prioridad (E21):</label><input type="text" id="E21"></div>
            <div><label>Act. Campo (L21):</label><input type="text" id="L21"></div>
            <div><label>MOP (T21):</label><input type="text" id="T21"></div>
        </div>
        <div class="grid-triple">
            <div><label>Direcci贸n (E22):</label><input type="text" id="E22"></div>
            <div><label>Act. MOP (L22):</label><input type="text" id="L22"></div>
            <div><label>Contrato (T22):</label><input type="text" id="T22"></div>
        </div>
        <div class="grid">
            <div><label>Acceso Cont. (E23):</label><input type="text" id="E23"></div>
            <div><label>Comentarios (L23):</label><input type="text" id="L23"></div>
        </div>
        <div class="grid-triple">
            <div>
                <label>Distrito (E24): Departamento/Provincia/Distrito</label>
                <input type="text" id="E24" list="listaUbigeoPeru" placeholder="Buscar: LIMA/LIMA/MIRAFLORES">
                <datalist id="listaUbigeoPeru"></datalist>
            </div>
            <div><label>Tipo Sitio (L24):</label><input type="text" id="L24"></div>
            <div><label>Servicio (T24):</label><input type="text" id="T24"></div>
        </div>
    </div>
    
    <script>
        let sitiosHistoricos = [];

        // 1. Cargar sitios desde MariaDB
        async function cargarSitiosHistoricos() {
            try {
                const res = await fetch('https://backend-reportes-excel.onrender.com/sitios-frecuentes');
                sitiosHistoricos = await res.json();
                const dl = document.getElementById('listaSitiosHistoricos');
                sitiosHistoricos.forEach(s => {
                    let opt = document.createElement('option');
                    opt.value = s.nombre_site;
                    dl.appendChild(opt);
                });
            } catch (e) { console.log("Error cargando sitios"); }
        }

        // 2. Vincular y Autorellenar Proyecto, Direcci贸n y Distrito
        function vincularDatosSite(valor) {
            const encontrado = sitiosHistoricos.find(s => s.nombre_site === valor);
            if (encontrado) {
                document.getElementById('L20').value = encontrado.proyecto || '';
                document.getElementById('E22').value = encontrado.direccion || '';
                document.getElementById('E24').value = encontrado.distrito || '';
            }
        }

        // 3. Cargar Base de Datos de Ubigeo Per煤 (Simplificado para el ejemplo, pero funcional)
        async function cargarUbigeoPeru() {
            // Aqu铆 consumimos un JSON con los 1,874 distritos del Per煤
            // Formato esperado: "DEPARTAMENTO/PROVINCIA/DISTRITO"
            try {
                const res = await fetch('https://raw.githubusercontent.com/joseluisq/ubigeo-peru/master/json/ubigeo_peru_2016_completo.json');
                const data = await res.json();
                const dlUbigeo = document.getElementById('listaUbigeoPeru');
                
                data.forEach(item => {
                    let opt = document.createElement('option');
                    // Construimos la cadena: DEP/PROV/DIST
                    opt.value = `${item.departamento}/${item.provincia}/${item.distrito}`;
                    dlUbigeo.appendChild(opt);
                });
            } catch (e) { console.log("Error cargando ubigeo"); }
        }

        // Inicializar al cargar el slide
        cargarSitiosHistoricos();
        cargarUbigeoPeru();
    </script>

    <div class="btn-nav">
        <button onclick="moveSlide(-1)">Anterior</button>
        <button onclick="moveSlide(1)">Pr贸ximo</button>
    </div>
</div>
            <!-- PARTE III: INSPECTOR -->
            <div class="slide">
                <div class="section">
                    <h2>III. DATOS DEL INSPECTOR</h2>
                    <label>INSPECTOR 01</label>
                    <div class="grid-quad">
                        <input type="text" id="D28" placeholder="Nombre">
                        <input type="text" id="H28" placeholder="Cargo">
                        <input type="text" id="O28" placeholder="Empresa">
                        <input type="text" id="T28" placeholder="DNI">
                    </div>
                    <label>INSPECTOR 02</label>
                    <div class="grid-quad">
                        <input type="text" id="D29" placeholder="Nombre">
                        <input type="text" id="H29" placeholder="Cargo">
                        <input type="text" id="O29" placeholder="Empresa">
                        <input type="text" id="T29" placeholder="DNI">
                    </div>
                    <div class="grid">
                        <div><label>Fecha Inicio (F30):</label><input type="date" id="F30"></div>
                        <div><label>Fecha Fin (R30):</label><input type="date" id="R30"></div>
                    </div>
                </div>
                <div class="btn-nav"><button onclick="moveSlide(-1)">Anterior</button><button onclick="moveSlide(1)">Pr贸ximo</button></div>
            </div>

            <!-- PARTE IV: CHECKLIST (ORDEN MODIFICADO SEGN SOLICITUD) -->
            <div class="slide">
                <div class="section">
                    <h2>IV. PREGUNTAS DE VERIFICACIN</h2>
                    <div id="checklist-container"></div>
                </div>
                <div class="btn-nav"><button onclick="moveSlide(-1)">Anterior</button><button onclick="enviarDatos()" style="background:#27ae60">GENERAR EXCEL</button></div>
            </div>
        </div>

        <!-- SECCIN HISTORIAL -->
        <div id="seccion-historial" style="display:none;">
            <h2> Historial de Reportes</h2>
            <table id="tablaHistorial">
                <thead>
                    <tr><th>Fecha</th><th>Site</th><th>Proyecto</th><th>Inspector</th><th>Acci贸n</th></tr>
                </thead>
                <tbody></tbody>
            </table>
        </div>

    </div>

    <script>
        let currentSlide = 0;
        const slides = document.querySelectorAll('.slide');
        function moveSlide(step) {
            slides[currentSlide].classList.remove('active');
            currentSlide += step;
            slides[currentSlide].classList.add('active');
            window.scrollTo(0,0);
        }

        const preguntas = [
            "Existencia de planos As-Built", "Verticalidad de estructura", "Torque de perner铆a estructural",
            "Pintura de balizaje", "Limpieza y desbroce", "Estado de cimentaci贸n", "L铆nea de vida", "Escalera de ascenso", 
            "Plataformas", "Soportes de antenas", "Bandejas porta cables", "Puesta a tierra", "Luces obstrucci贸n", 
            "Pararrayos", "Mimetizado", "Cerco perim茅trico", "Puerta de acceso", "Letreros", "Pernos anclaje", 
            "Nivelaci贸n perfiles", "Oxidaci贸n", "Galvanizado", "Pernos seguridad", "Abrazaderas", "Conectores tierra", 
            "Bajantes tierra", "Pozo a tierra", "Pintura base", "Fisuras concreto", "Drenajes", "Roxtec", 
            "Cableado RF", "Cableado Energ铆a", "Etiquetado", "Ordenamiento", "Prot. Lluvia", "Gabinetes", 
            "Ventilaci贸n", "Alarmas", "Prot. Aves", "Cerraduras", "Iluminaci贸n", "Extintor", "Botiqu铆n", "Limpieza"
        ];

        const container = document.getElementById('checklist-container');
        preguntas.forEach((p, i) => {
            const n = i + 1;
            const div = document.createElement('div');
            div.className = 'checklist-item';
            div.innerHTML = `
                <span>${n}. ${p}</span>
                <select id="I_P${n}"><option value="SI">SI</option><option value="NO">NO</option><option value="N/A">N/A</option></select>
                <select id="G_P${n}"><option value="NO">NO PARAL.</option><option value="SI">SI PARAL.</option></select>
                <input type="text" id="K_P${n}" placeholder="Comentarios">
            `;
            container.appendChild(div);
        });

        function cambiarSeccion(t) {
            document.getElementById('seccion-app').style.display = (t === 'app' ? 'block' : 'none');
            document.getElementById('seccion-historial').style.display = (t === 'hist' ? 'block' : 'none');
            document.getElementById('tab-app').classList.toggle('active', t === 'app');
            document.getElementById('tab-hist').classList.toggle('active', t === 'hist');
            if(t === 'hist') cargarHistorial();
        }

        async function enviarDatos() {
            const data = {};
            const ids = ["E11","T11","D12","H12","O12","T12","D13","H13","O13","T13","D14","H14","O14","T14","D15","H15","O15","T15","D16","H16","O16","T16","E20","L20","T20","E21","L21","T21","E22","L22","T22","E23","L23","E24","L24","T24","D28","H28","O28","T28","D29","H29","O29","T29","F30","R30"];
            ids.forEach(id => { data[id] = document.getElementById(id).value; });
            for(let i=1; i<=45; i++) {
                data[`G_P${i}`] = document.getElementById(`G_P${i}`).value;
                data[`I_P${i}`] = document.getElementById(`I_P${i}`).value;
                data[`K_P${i}`] = document.getElementById(`K_P${i}`).value;
            }

            try {
                const res = await fetch('https://backend-reportes-excel.onrender.com/generar-reporte', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                if(res.ok) {
                    const b = await res.blob();
                    const a = document.createElement('a');
                    a.href = window.URL.createObjectURL(b);
                    a.download = `Reporte_${data.E20}.xlsx`;
                    a.click();
                }
            } catch(e) { alert("Error de servidor"); }
        }

        async function cargarHistorial() {
            const tbody = document.querySelector('#tablaHistorial tbody');
            tbody.innerHTML = '<tr><td colspan="5">Cargando...</td></tr>';
            try {
                const res = await fetch('https://backend-reportes-excel.onrender.com/historial-datos');
                const datos = await res.json();
                tbody.innerHTML = '';
                datos.forEach(r => {
                    tbody.innerHTML += `<tr>
                        <td>${new Date(r.fecha_registro).toLocaleString()}</td>
                        <td>${r.nombre_site}</td><td>${r.proyecto}</td><td>${r.inspector_nombre}</td>
                        <td><button onclick="window.location.href='https://backend-reportes-excel.onrender.com/regenerar-excel/${r.id}'" style="background:#27ae60; padding:5px;"></button></td>
                    </tr>`;
                });
            } catch(e) { tbody.innerHTML = '<td>Error</td>'; }
        }
    </script>
</body>
</html>



