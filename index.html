<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte Técnico AENOR - Final</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root { --primary: #4a90e2; --secondary: #357abd; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); display: flex; justify-content: center; padding: 20px; }
        .container { background: white; width: 100%; max-width: 900px; padding: 30px; border-radius: 12px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .slide { display: none; } .slide.active { display: block; }
        h3 { border-bottom: 2px solid var(--primary); padding-bottom: 10px; color: var(--primary); }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin-bottom: 20px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.85rem; color: #333; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 6px; box-sizing: border-box; }
        .buttons { display: flex; justify-content: space-between; margin-top: 20px; }
        button { padding: 12px 25px; border: none; border-radius: 6px; cursor: pointer; font-weight: bold; transition: 0.3s; }
        .btn-next { background: var(--primary); color: white; }
        .btn-export { background: #27ae60; color: white; display: none; width: 100%; font-size: 1.1rem; }
        button:disabled { background: #ccc; }
    </style>
</head>
<body>
<div class="container">
    <form id="formReporte">
        <div class="slide active">
            <h3>I.- DATOS DEL COOPERADOR</h3>
            <div class="form-grid">
                <div><label>Razón Social (E11)</label><input type="text" name="E11"></div>
                <div><label>RUC (T11)</label><input type="text" name="T11"></div>
            </div>
            <div class="form-grid">
                <div><label>P1 Nombre (D12)</label><input type="text" name="D12"></div>
                <div><label>P1 Cargo (H12)</label><input type="text" name="H12"></div>
                <div><label>P1 Empresa (O12)</label><input type="text" name="O12"></div>
                <div><label>P1 DNI (T12)</label><input type="text" name="T12"></div>
            </div>
            <div class="form-grid">
                <div><label>P2 Nombre (D13)</label><input type="text" name="D13"></div>
                <div><label>P2 Cargo (H13)</label><input type="text" name="H13"></div>
                <div><label>P2 Empresa (O13)</label><input type="text" name="O13"></div>
                <div><label>P2 DNI (T13)</label><input type="text" name="T13"></div>
            </div>
        </div>

        <div class="slide">
            <h3>II.- DATOS DEL PROYECTO Y SITE</h3>
            <div class="form-grid">
                <div><label>Nombre Site (E20)</label><input type="text" name="E20"></div>
                <div><label>Proyecto (L20)</label><input type="text" name="L20"></div>
                <div><label>Solución (T20)</label><input type="text" name="T20"></div>
            </div>
            <div class="form-grid">
                <div><label>Prioridad (E21)</label><input type="text" name="E21"></div>
                <div><label>Actividad Campo (L21)</label><input type="text" name="L21"></div>
                <div><label>N° MOP (T21)</label><input type="text" name="T21"></div>
            </div>
            <div class="form-grid">
                <div><label>Dirección (E22)</label><input type="text" name="E22"></div>
                <div><label>Actividad MOP (L22)</label><input type="text" name="L22"></div>
                <div><label>N° Contrato (T22)</label><input type="text" name="T22"></div>
            </div>
            <div class="form-grid">
                <div><label>Acceso Contingente (E23)</label><input type="text" name="E23"></div>
                <div><label>Comentarios (L23)</label><input type="text" name="L23"></div>
            </div>
            <div class="form-grid">
                <div><label>Distrito/Prov/Dpto (E24)</label><input type="text" name="E24"></div>
                <div><label>Tipo de Sitio (L24)</label><input type="text" name="L24"></div>
                <div><label>Servicio Inspeccionado (T24)</label><input type="text" name="T24"></div>
            </div>
        </div>

        <div class="slide">
            <h3>III.- DATOS DEL INSPECTOR</h3>
            <div class="form-grid">
                <div><label>Inspector 1 (D28)</label><input type="text" name="D28"></div>
                <div><label>Cargo (H28)</label><input type="text" name="H28"></div>
                <div><label>Empresa (O28)</label><input type="text" name="O28"></div>
                <div><label>DNI (T28)</label><input type="text" name="T28"></div>
            </div>
            <div class="form-grid">
                <div><label>Inspector 2 (D29)</label><input type="text" name="D29"></div>
                <div><label>Cargo (H29)</label><input type="text" name="H29"></div>
                <div><label>Empresa (O29)</label><input type="text" name="O29"></div>
                <div><label>DNI (T29)</label><input type="text" name="T29"></div>
            </div>
            <div class="form-grid">
                <div><label>Inicio Supervisión (F30)</label><input type="date" name="F30"></div>
                <div><label>Fin Supervisión (R30)</label><input type="date" name="R30"></div>
            </div>
        </div>

        <div class="slide">
            <h3>IV.- PREGUNTAS DE VERIFICACIÓN</h3>
            <div style="overflow-y: auto; max-height: 400px; border: 1px solid #eee; padding: 10px;">
                <table id="checklistTable">
                    <tbody id="checklist-tbody"></tbody>
                </table>
            </div>
            <button type="button" class="btn-export" id="btnExportar" onclick="generarExcel()">GENERAR REPORTE EXCEL</button>
        </div>

        <div class="buttons">
            <button type="button" onclick="changeSlide(-1)">Anterior</button>
            <button type="button" id="btnNext" onclick="changeSlide(1)">Próximo</button>
        </div>
    </form>
</div>

<script>
    let currentSlide = 0;
    const slides = document.querySelectorAll(".slide");
    const preguntas = ["Cimentación", "Pernos de anclaje", "Grouting", "Estructura metálica", "Pernos de conexión", "Soldadura", "Galvanizado", "Pintura", "Escaleras", "Línea de vida", "Plataformas", "Soportes de antena", "Soportes de microondas", "Verticalidad", "Torsión", "Cableado", "Puesta a tierra", "Identificación", "Limpieza", "Vegetación", "Desechos", "Cercos", "Puertas", "Candados", "Señalización", "Luces de obstrucción", "Pararrayos", "Estructuras adosadas", "Estado de muros", "Estado de techos", "Filtraciones", "Humedad", "Grietas", "Fisuras", "Desprendimientos", "Nido de aves", "Corrosión leve", "Corrosión moderada", "Corrosión severa", "Pandeo", "Falta de pernos", "Pernos flojos", "Vibración", "Ruidos extraños", "Otros"];

    function initChecklist() {
        const tbody = document.getElementById("checklist-tbody");
        preguntas.forEach((p, i) => {
            tbody.innerHTML += `<tr><td style="width:50%">${i+1}. ${p}</td>
                <td><select name="G_P${i+1}"><option value="N/A">N/A</option><option value="SI">SI</option><option value="NO">NO</option></select></td>
                <td><input type="checkbox" name="I_P${i+1}" value="SI"></td>
                <td><input type="text" name="K_P${i+1}" placeholder="Obs"></td></tr>`;
        });
    }

    function changeSlide(n) {
        slides[currentSlide].classList.remove("active");
        currentSlide += n;
        document.getElementById("btnNext").style.display = (currentSlide === slides.length - 1) ? "none" : "block";
        document.getElementById("btnExportar").style.display = (currentSlide === slides.length - 1) ? "block" : "none";
        slides[currentSlide].classList.add("active");
    }

    async function generarExcel() {
        const btn = document.getElementById("btnExportar");
        btn.disabled = true; btn.innerHTML = "GENERANDO...";
        const formData = new FormData(document.getElementById("formReporte"));
        const data = Object.fromEntries(formData.entries());
        
        try {
            const response = await fetch('https://backend-reportes-excel.onrender.com/generar-reporte', {
                method: 'POST',
                body: JSON.stringify(data),
                headers: { 'Content-Type': 'application/json' }
            });
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = `REPORTE_${data.E20 || 'AENOR'}.xlsx`; a.click();
        } catch (e) { alert("Error de servidor"); }
        finally { btn.disabled = false; btn.innerHTML = "GENERAR REPORTE EXCEL"; }
    }
    initChecklist();
</script>
</body>
</html>
