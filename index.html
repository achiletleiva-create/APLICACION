<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte T√©cnico AENOR - Sistema Unificado</title>
    <style>
        :root { --primary: #005c97; --secondary: #363795; --success: #27ae60; --bg: #f4f7f6; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); margin: 0; padding: 20px; }
        
        /* Navegaci√≥n por Pesta√±as */
        .nav-tabs { display: flex; justify-content: center; gap: 10px; margin-bottom: 25px; }
        .nav-tabs button { 
            padding: 12px 25px; border: none; background: #ddd; cursor: pointer; 
            border-radius: 8px; font-weight: bold; transition: 0.3s; font-size: 1rem;
        }
        .nav-tabs button.active { background: var(--primary); color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }

        .container { max-width: 1000px; margin: auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        h1, h2 { color: var(--primary); text-align: center; }
        
        /* Estilos del Formulario */
        .bloque { border: 1px solid #e0e0e0; padding: 20px; border-radius: 10px; margin-bottom: 25px; background: #fafafa; }
        .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        label { display: block; font-weight: bold; margin-bottom: 5px; font-size: 0.9rem; color: #555; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 5px; box-sizing: border-box; }
        
        /* Estilos del Checklist */
        .check-item { display: grid; grid-template-columns: 1fr 100px 200px; gap: 10px; padding: 10px 0; border-bottom: 1px solid #eee; align-items: center; }
        .btn-enviar { background: var(--primary); color: white; padding: 15px; border: none; width: 100%; border-radius: 8px; font-size: 1.1rem; cursor: pointer; margin-top: 20px; font-weight: bold; }
        .btn-enviar:hover { background: var(--secondary); }

        /* Estilos de la Tabla de Historial */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 0.9rem; }
        th { background: var(--primary); color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #eee; }
        tr:hover { background: #f9f9f9; }
        .btn-descarga { background: var(--success); color: white; border: none; padding: 8px 12px; border-radius: 5px; cursor: pointer; text-decoration: none; font-size: 0.8rem; }
        
        #loadingOverlay { display: none; position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.8); z-index:1000; flex-direction:column; justify-content:center; align-items:center; }
    </style>
</head>
<body>

    <div id="loadingOverlay">
        <div style="border: 5px solid #f3f3f3; border-top: 5px solid var(--primary); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite;"></div>
        <p>Procesando informaci√≥n...</p>
    </div>

    <div class="nav-tabs">
        <button onclick="cambiarPesta√±a('formulario')" id="tab-form" class="active">üìù Nuevo Reporte</button>
        <button onclick="cambiarPesta√±a('historial')" id="tab-hist">üìã Historial de Inspecciones</button>
    </div>

    <div class="container">
        <!-- SECCI√ìN 1: FORMULARIO -->
        <div id="seccion-formulario">
            <h1>Reporte T√©cnico AENOR</h1>
            
            <!-- BLOQUE 1: COOPERADOR -->
            <div class="bloque">
                <h2>I. Datos del Cooperador</h2>
                <div class="grid">
                    <div><label>Raz√≥n Social (E11)</label><input type="text" id="E11" value="ENTEL PERU S.A."></div>
                    <div><label>RUC (T11)</label><input type="text" id="T11" value="20106897914"></div>
                </div>
                <div class="grid" style="margin-top:15px">
                    <div><label>Personal 01 (D12)</label><input type="text" id="D12"></div>
                    <div><label>DNI/CE (T12)</label><input type="text" id="T12"></div>
                </div>
            </div>

            <!-- BLOQUE 2: PROYECTO Y SITE -->
            <div class="bloque">
                <h2>II. Datos del Proyecto y Site</h2>
                <div class="grid">
                    <div><label>Nombre Site (E20)</label><input type="text" id="E20" placeholder="Ej: LIM-123"></div>
                    <div><label>Proyecto (L20)</label><input type="text" id="L20"></div>
                    <div><label>Soluci√≥n (T20)</label><input type="text" id="T20"></div>
                </div>
                <div class="grid" style="margin-top:10px">
                    <div><label>Prioridad (E21)</label><input type="text" id="E21"></div>
                    <div><label>Distrito (E24)</label><input type="text" id="E24"></div>
                    <div><label>Servicio (T24)</label><input type="text" id="T24"></div>
                </div>
            </div>

            <!-- BLOQUE 3: INSPECTOR -->
            <div class="bloque">
                <h2>III. Datos del Inspector</h2>
                <div class="grid">
                    <div><label>Nombre Inspector (D28)</label><input type="text" id="D28"></div>
                    <div><label>DNI (T28)</label><input type="text" id="T28"></div>
                    <div><label>Fecha Inicio (F30)</label><input type="date" id="F30"></div>
                </div>
            </div>

            <!-- BLOQUE 4: CHECKLIST -->
            <div class="bloque">
                <h2>IV. Verificaci√≥n de Estructura</h2>
                <div id="contenedorChecklist">
                    <!-- Generado por JS -->
                </div>
            </div>

            <button class="btn-enviar" onclick="enviarDatos()">üöÄ Generar y Guardar Reporte</button>
        </div>

        <!-- SECCI√ìN 2: HISTORIAL -->
        <div id="seccion-historial" style="display:none;">
            <h2>üìã Historial de Reportes Guardados</h2>
            <p style="text-align:center; color: #666;">Registros almacenados en el servidor Debian via Render</p>
            <table id="tablaHistorial">
                <thead>
                    <tr>
                        <th>Fecha Registro</th>
                        <th>Nombre Site</th>
                        <th>Proyecto</th>
                        <th>Inspector</th>
                        <th>Acci√≥n</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- Se llena din√°micamente -->
                </tbody>
            </table>
        </div>
    </div>

    <script>
        const BACKEND_URL = "https://backend-reportes-excel.onrender.com";

        // 1. GESTI√ìN DE PESTA√ëAS
        function cambiarPesta√±a(pesta√±a) {
            if (pesta√±a === 'formulario') {
                document.getElementById('seccion-formulario').style.display = 'block';
                document.getElementById('seccion-historial').style.display = 'none';
                document.getElementById('tab-form').classList.add('active');
                document.getElementById('tab-hist').classList.remove('active');
            } else {
                document.getElementById('seccion-formulario').style.display = 'none';
                document.getElementById('seccion-historial').style.display = 'block';
                document.getElementById('tab-form').classList.remove('active');
                document.getElementById('tab-hist').classList.add('active');
                cargarHistorial();
            }
        }

        // 2. GENERACI√ìN DIN√ÅMICA DEL CHECKLIST (45 items)
        const checklistItems = [
            "Existencia de planos", "Certificado de verticalidad", "Estado de pintura", 
            "Ajuste de perner√≠a", "Estado de escalerilla", "Soportes de antenas",
            "L√≠nea de vida", "Sistema de puesta a tierra", "Limpieza de √°rea"
            // Puedes a√±adir los 45 nombres aqu√≠ o dejarlo como Item 1, 2...
        ];

        const contenedor = document.getElementById('contenedorChecklist');
        for (let i = 1; i <= 45; i++) {
            const div = document.createElement('div');
            div.className = 'check-item';
            div.innerHTML = `
                <span>${i}. ${checklistItems[i-1] || 'Punto de inspecci√≥n ' + i}</span>
                <select id="I_P${i}"><option value="SI">SI</option><option value="NO">NO</option><option value="N/A">N/A</option></select>
                <input type="text" id="K_P${i}" placeholder="Observaciones (Celda K)">
            `;
            contenedor.appendChild(div);
        }

        // 3. ENVIAR DATOS AL BACKEND
        async function enviarDatos() {
            const loader = document.getElementById('loadingOverlay');
            loader.style.display = 'flex';

            const data = {};
            // Captura de campos directos
            const campos = ['E11','T11','D12','T12','E20','L20','T20','E21','E24','T24','D28','T28','F30'];
            campos.forEach(id => { data[id] = document.getElementById(id).value; });

            // Captura de checklist
            for (let i = 1; i <= 45; i++) {
                data[`I_P${i}`] = document.getElementById(`I_P${i}`).value;
                data[`K_P${i}`] = document.getElementById(`K_P${i}`).value;
                data[`G_P${i}`] = "Referencia"; // Valor por defecto para columna G
            }

            try {
                const response = await fetch(`${BACKEND_URL}/generar-reporte`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(data)
                });

                if (response.ok) {
                    const blob = await response.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `Reporte_${data.E20 || 'Final'}.xlsx`;
                    document.body.appendChild(a);
                    a.click();
                    alert("‚úÖ Reporte generado y guardado en historial.");
                } else {
                    alert("‚ùå Error en el servidor.");
                }
            } catch (error) {
                alert("‚ùå Error de conexi√≥n: " + error.message);
            } finally {
                loader.style.display = 'none';
            }
        }

        // 4. CARGAR HISTORIAL DESDE LA DB
        async function cargarHistorial() {
            const tbody = document.querySelector('#tablaHistorial tbody');
            tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">Conectando con Debian...</td></tr>';

            try {
                const response = await fetch(`${BACKEND_URL}/historial-datos`);
                const datos = await response.json();
                tbody.innerHTML = '';

                if (datos.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="5" style="text-align:center">No hay registros a√∫n.</td></tr>';
                    return;
                }

                datos.forEach(reg => {
                    const fecha = new Date(reg.fecha_registro).toLocaleString('es-PE');
                    tbody.innerHTML += `
                        <tr>
                            <td>${fecha}</td>
                            <td>${reg.nombre_site || 'N/A'}</td>
                            <td>${reg.proyecto || 'N/A'}</td>
                            <td>${reg.inspector_nombre || 'N/A'}</td>
                            <td>
                                <button onclick="descargarCopia(${reg.id})" class="btn-descarga">üì• Excel</button>
                            </td>
                        </tr>`;
                });
            } catch (error) {
                tbody.innerHTML = `<tr><td colspan="5" style="color:red; text-align:center">‚ö†Ô∏è Error: ${error.message}</td></tr>`;
            }
        }

        function descargarCopia(id) {
            window.location.href = `${BACKEND_URL}/regenerar-excel/${id}`;
        }

        // Estilo de animaci√≥n para el loader
        const style = document.createElement('style');
        style.innerHTML = `@keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }`;
        document.head.appendChild(style);
    </script>
</body>
</html>
